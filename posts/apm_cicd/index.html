<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        APM en mode avec CI/CD avec sitespeed.io ::
        Klanik tech blog — Tech blog
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="L’« Application Performance Management » couvre l’ensemble de la démarche visant à monitorer et améliorer la performance des sites et applications web. C’est donc une discipline importante à époque où le temps de chargement trop long d’une page peut ruiner la réputation ou le business d’une marque ou entreprise.
J’ai présenté sitespeed.io, outil de test de la performance des sites web il y a quelques années déjà. Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que j’en pensais à l’époque."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/apm_cicd/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="APM en mode avec CI/CD avec sitespeed.io"/>
<meta name="twitter:description" content="L’« Application Performance Management » couvre l’ensemble de la démarche visant à monitorer et améliorer la performance des sites et applications web. C’est donc une discipline importante à époque où le temps de chargement trop long d’une page peut ruiner la réputation ou le business d’une marque ou entreprise.
J’ai présenté sitespeed.io, outil de test de la performance des sites web il y a quelques années déjà. Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que j’en pensais à l’époque."/>



<meta property="og:title" content="APM en mode avec CI/CD avec sitespeed.io" />
<meta property="og:description" content="L’« Application Performance Management » couvre l’ensemble de la démarche visant à monitorer et améliorer la performance des sites et applications web. C’est donc une discipline importante à époque où le temps de chargement trop long d’une page peut ruiner la réputation ou le business d’une marque ou entreprise.
J’ai présenté sitespeed.io, outil de test de la performance des sites web il y a quelques années déjà. Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que j’en pensais à l’époque." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/apm_cicd/" />
<meta property="article:published_time" content="2020-10-13T17:54:02+02:00" />
<meta property="article:modified_time" content="2020-10-13T17:54:02+02:00" /><meta property="og:site_name" content="Klanik tech blog" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Klanik tech blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://www.klanik.com">Klanik.com</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://www.klanik.com">Klanik.com</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">APM en mode avec CI/CD avec sitespeed.io</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-10-13
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 5 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
        <h2>Table of Contents</h2>
        <aside class="table-of-contents"><nav id="TableOfContents"></nav></aside>
      
      <p>L’« Application Performance Management » couvre l’ensemble de la démarche visant à monitorer et améliorer la performance des sites et applications web. C’est donc une discipline importante à époque où le temps de chargement trop long d’une page peut ruiner la réputation ou le business d’une marque ou entreprise.</p>
<p>J’ai présenté sitespeed.io, outil de test de la performance des sites web il y a quelques années déjà. Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que j’en pensais à l’époque. Et ça n’a pas changé; bien au contraire vu les nombreuses évolutions positives qu’a connu cet outil depuis.</p>
<p>Je vous propose dans ce qui pourrait être la suite du précédent billet d’automatiser les tests faits avec sitespeed.io et de voir quels sont les possibilités d’intégration dans une chaîne de CI/CD. A partir de là, il devient possible de tester une application ou site web:</p>
<p>A la façon GitOps, de façon automatique à la moindre modification du dépôt du code source applicatif.
Dans un esprit plus « observabilité, monitoring », ordonnancer des contrôles à intervalles réguliers de l’application.
Quoique ce soit votre préférence, il me paraît important de rappeler que le mode opératoire le plus pratique pour sitespeed.io est basé sur une image Docker et que c’est celui-ci que nous allons utiliser. Cela permet d’envisager l’automatisation des choses suivantes:</p>
<p>Démarrage d’un conteneur Docker à partir de l’image officielle sitespeed.io.
Exécution du test sitespeed.io dans ce conteneur.
Récupération des résultats.
Destruction du conteneur Docker.
CONFIGURATION DE SITESPEED.IO
Il est possible de configurer sitespeed.io de deux façons différentes:</p>
<p>A partir d’options et arguments sur la ligne commande.
A partir d’un fichier de configuration au format JSON.
Nous privilégierons la deuxième méthode, le fichier JSON pouvant être facilement généré automatiquement depuis la description, le « blueprint » de l’application.</p>
<p>Configuration pour le CI/CD
La liste des options de configuration de sitespeed.io est juste énorme et je ne compte pas vous les décrire toutes… Heureusement pour tout le monde! Nous allons juste parcourir les quelques options qui me semblent intéressantes à utiliser quand sitespeed.io est « opéré » en mode automatique.</p>
<p>Configuration S3
Il est possible de stocker le rapport HTML généré par sitespeed.io dans un stockage compatible Amazon S3. Cette option est utile si vous souhaitez par exemple que les développeurs puissent avoir accès au détail d’un test réalisé. J’utilise Minio comme stockage compatible S3 et la configuration nécessaire pour que cela fonctionne avec sitespeed.io est la suivante:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">s</span><span style="color:#ae81ff">3</span> <span style="color:#960050;background-color:#1e0010">»:</span> 
{ <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">endpoint</span> <span style="color:#960050;background-color:#1e0010">»:</span> 
<span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">http://192.168.1.7:9000</span> <span style="color:#960050;background-color:#1e0010">»,</span> 
<span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">bucketname</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">speedio</span> <span style="color:#960050;background-color:#1e0010">»,</span> 
<span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">removeLocalResult</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">true,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">key</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">miniouser</span> <span style="color:#960050;background-color:#1e0010">»,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">secret</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">miniopassword</span> <span style="color:#960050;background-color:#1e0010">»,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">options</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">{</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">s3ForcePathStyle</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">true,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">s3BucketEndpoint</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">true</span> } <span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>Il est possible d’utiliser le module « Google Cloud Storage » pour arriver à un résultat identique.</p>
<p>Configuration Graphite
Il paraît évident qu’une chaîne de CI/CD sans monitoring n’en est pas vraiment une… Mais ça va toujours mieux en le reprécisant 🙂 Dans ce scope, Graphite reste bien sûr un standard et nous allons donc utiliser le module correspondant pour pouvoir récupérer l’ensemble des métriques récoltées par sitepseedio au cours d’un test. Grafana permettra la visualisation des métriques récoltées. Voici la configuration du module Graphite:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">graphite</span> <span style="color:#960050;background-color:#1e0010">»:</span> { <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">host</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">192.168.1.79</span> <span style="color:#960050;background-color:#1e0010">»,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">port</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">9109,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">includeQueryParams</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">false,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">arrayTags</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">false,</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">namespace</span> <span style="color:#960050;background-color:#1e0010">»:</span> <span style="color:#960050;background-color:#1e0010">«</span> <span style="color:#960050;background-color:#1e0010">speedio</span> <span style="color:#960050;background-color:#1e0010">»</span> }<span style="color:#960050;background-color:#1e0010">,</span>
</code></pre></div><p>C’est une configuration minimale pour envoyer les métriques vers un serveur compatible Graphite mais vous pouvez aller beaucoup plus loin avec des tags, des annotations à disposition. Pour ma part, j’utilise plutôt Prometheus que Graphite et j’ai donc utilisé Graphite Exporter et ces possibilités de « mapping » pour arriver au même résultat qu’avec un serveur Graphite. Vous pouvez aussi utiliser InfluxDB en lieu et place de Graphite si tel est votre bon plaisir.</p>
<p>Autres options de configuration intéressantes
Je n’ai pas encore mis en oeuvre les options de configuration suivantes mais il est possible, à l’instar du module Graphite vu plus haut, d’envoyer des annotations vers Grafana. Il est également possible de paramétrer un « budget performance » pour votre application. Et enfin, la toute nouvelle version 12 de sitespeed.io permet désormais de calculer l’impact écologique de votre application web.</p>
<p>INTÉGRATION CI/CD
Une fois sitespeed.io configuré, il ne reste plus qu’à orchestrer le tout avec l’outil de votre choix; Ansible dans mon cas. Voici donc un playbook « quick and dirty » permettant de charger la liste des sites à tester depuis un fichier web.txt et de créer le conteneur Docker pour chacun. Notez l’appel au fichier de configuration avec &ndash;config config.json. Un script bash aurait certainement pu faire l’affaire mais utiliser Ansible ou un équivalent permet de pouvoir paramétrer le tout finement et d’aller plus loin avec par exemple un fichier de configuration différent par application…</p>
<p>— – name: sitespeed.io docker run hosts: localhost connection: local gather_facts: no become: no vars: iso8601_date: « {{ lookup(‘pipe’, ‘date -u +%Y-%m-%dT%H:%M:%S+00:00’) }}«  root_dir: « {{ lookup(‘env’, ‘PWD’) }}«  tasks: – name: docker_container | check url from file ‘web.txt’ with sitespeed.io docker_container: name: « speedio_{{ site_idx }}«  image: sitespeedio/sitespeed.io:12.1.0 auto_remove: yes network_mode: bridge recreate: yes command: « {{ item }} –config config.json » env: https_proxy: «  » http_proxy: «  » volumes: – « {{ root_dir }}:/sitespeed.io » loop: « {{ lookup(‘file’, ‘./web.txt’).splitlines() }}«  loop_control: index_var: site_idx
Ceci n’est bien sûr qu’une base Ansible à adapter à votre environnement, votre contexte. Il reste à intégrer ce playbook dans un pipeline CI/CD, que ce soit Jenkins, Gitlab, Github ou Drone. Il est également possible d’exécuter ce playbook à intervalles réguliers depuis Jenkins, Rundeck, AWX ou depuis votre logiciel de supervision.</p>
<p>En fonction de l’intégration choisie, il peut y avoir pas mal de travail annexe à faire comme la construction de tableaux de bord pour Grafana, un fichier de mapping pour Graphite Exporter… En guise de conclusion, les combinaisons envisageables sont très étendues.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/introduction_au_serverless/">
                  <span class="button__text">Introduction au serverless</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Klanik tech blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2020 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
