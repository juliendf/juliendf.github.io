<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        APM en mode avec CI/CD avec sitespeed.io ::
        Klanik tech blog â€” Tech blog
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Lâ€™Â«â€¯Application Performance Managementâ€¯Â» couvre lâ€™ensemble de la dÃ©marche visant Ã  monitorer et amÃ©liorer la performance des sites et applications web. Câ€™est donc une discipline importante Ã  Ã©poque oÃ¹ le temps de chargement trop long dâ€™une page peut ruiner la rÃ©putation ou le business dâ€™une marque ou entreprise.
Jâ€™ai prÃ©sentÃ© sitespeed.io, outil de test de la performance des sites web il y a quelques annÃ©es dÃ©jÃ . Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que jâ€™en pensais Ã  lâ€™Ã©poque."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/apm_cicd/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="APM en mode avec CI/CD avec sitespeed.io"/>
<meta name="twitter:description" content="Lâ€™Â«â€¯Application Performance Managementâ€¯Â» couvre lâ€™ensemble de la dÃ©marche visant Ã  monitorer et amÃ©liorer la performance des sites et applications web. Câ€™est donc une discipline importante Ã  Ã©poque oÃ¹ le temps de chargement trop long dâ€™une page peut ruiner la rÃ©putation ou le business dâ€™une marque ou entreprise.
Jâ€™ai prÃ©sentÃ© sitespeed.io, outil de test de la performance des sites web il y a quelques annÃ©es dÃ©jÃ . Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que jâ€™en pensais Ã  lâ€™Ã©poque."/>



<meta property="og:title" content="APM en mode avec CI/CD avec sitespeed.io" />
<meta property="og:description" content="Lâ€™Â«â€¯Application Performance Managementâ€¯Â» couvre lâ€™ensemble de la dÃ©marche visant Ã  monitorer et amÃ©liorer la performance des sites et applications web. Câ€™est donc une discipline importante Ã  Ã©poque oÃ¹ le temps de chargement trop long dâ€™une page peut ruiner la rÃ©putation ou le business dâ€™une marque ou entreprise.
Jâ€™ai prÃ©sentÃ© sitespeed.io, outil de test de la performance des sites web il y a quelques annÃ©es dÃ©jÃ . Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que jâ€™en pensais Ã  lâ€™Ã©poque." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/apm_cicd/" />
<meta property="article:published_time" content="2020-10-13T17:54:02+02:00" />
<meta property="article:modified_time" content="2020-10-13T17:54:02+02:00" /><meta property="og:site_name" content="Klanik tech blog" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Klanik tech blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://www.klanik.com">Klanik.com</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://www.klanik.com">Klanik.com</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">APM en mode avec CI/CD avec sitespeed.io</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-10-13
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >â€” 5 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
        <h2>Table of Contents</h2>
        <aside class="table-of-contents"><nav id="TableOfContents"></nav></aside>
      
      <p>Lâ€™Â«â€¯Application Performance Managementâ€¯Â» couvre lâ€™ensemble de la dÃ©marche visant Ã  monitorer et amÃ©liorer la performance des sites et applications web. Câ€™est donc une discipline importante Ã  Ã©poque oÃ¹ le temps de chargement trop long dâ€™une page peut ruiner la rÃ©putation ou le business dâ€™une marque ou entreprise.</p>
<p>Jâ€™ai prÃ©sentÃ© sitespeed.io, outil de test de la performance des sites web il y a quelques annÃ©es dÃ©jÃ . Il vous suffit de (re)lire ce billet pour vous rendre compte de tout le bien que jâ€™en pensais Ã  lâ€™Ã©poque. Et Ã§a nâ€™a pas changÃ©; bien au contraire vu les nombreuses Ã©volutions positives quâ€™a connu cet outil depuis.</p>
<p>Je vous propose dans ce qui pourrait Ãªtre la suite du prÃ©cÃ©dent billet dâ€™automatiser les tests faits avec sitespeed.io et de voir quels sont les possibilitÃ©s dâ€™intÃ©gration dans une chaÃ®ne de CI/CD. A partir de lÃ , il devient possible de tester une application ou site web:</p>
<p>A la faÃ§on GitOps, de faÃ§on automatique Ã  la moindre modification du dÃ©pÃ´t du code source applicatif.
Dans un esprit plus Â«â€¯observabilitÃ©, monitoringâ€¯Â», ordonnancer des contrÃ´les Ã  intervalles rÃ©guliers de lâ€™application.
Quoique ce soit votre prÃ©fÃ©rence, il me paraÃ®t important de rappeler que le mode opÃ©ratoire le plus pratique pour sitespeed.io est basÃ© sur une image Docker et que câ€™est celui-ci que nous allons utiliser. Cela permet dâ€™envisager lâ€™automatisation des choses suivantes:</p>
<p>DÃ©marrage dâ€™un conteneur Docker Ã  partir de lâ€™image officielle sitespeed.io.
ExÃ©cution du test sitespeed.io dans ce conteneur.
RÃ©cupÃ©ration des rÃ©sultats.
Destruction du conteneur Docker.
CONFIGURATION DE SITESPEED.IO
Il est possible de configurer sitespeed.io de deux faÃ§ons diffÃ©rentes:</p>
<p>A partir dâ€™options et arguments sur la ligne commande.
A partir dâ€™un fichier de configuration au format JSON.
Nous privilÃ©gierons la deuxiÃ¨me mÃ©thode, le fichier JSON pouvant Ãªtre facilement gÃ©nÃ©rÃ© automatiquement depuis la description, le Â«â€¯blueprintâ€¯Â» de lâ€™application.</p>
<p>Configuration pour le CI/CD
La liste des options de configuration de sitespeed.io est juste Ã©norme et je ne compte pas vous les dÃ©crire toutesâ€¦ Heureusement pour tout le monde! Nous allons juste parcourir les quelques options qui me semblent intÃ©ressantes Ã  utiliser quand sitespeed.io est Â«â€¯opÃ©rÃ©â€¯Â» en mode automatique.</p>
<p>Configuration S3
Il est possible de stocker le rapport HTML gÃ©nÃ©rÃ© par sitespeed.io dans un stockage compatible Amazon S3. Cette option est utile si vous souhaitez par exemple que les dÃ©veloppeurs puissent avoir accÃ¨s au dÃ©tail dâ€™un test rÃ©alisÃ©. Jâ€™utilise Minio comme stockage compatible S3 et la configuration nÃ©cessaire pour que cela fonctionne avec sitespeed.io est la suivante:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">s</span><span style="color:#ae81ff">3</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> 
{ <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">endpoint</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> 
<span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">http://192.168.1.7:9000</span> <span style="color:#960050;background-color:#1e0010">Â»,</span> 
<span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">bucketname</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">speedio</span> <span style="color:#960050;background-color:#1e0010">Â»,</span> 
<span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">removeLocalResult</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">true,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">key</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">miniouser</span> <span style="color:#960050;background-color:#1e0010">Â»,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">secret</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">miniopassword</span> <span style="color:#960050;background-color:#1e0010">Â»,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">options</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">{</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">s3ForcePathStyle</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">true,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">s3BucketEndpoint</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">true</span> } <span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>Il est possible dâ€™utiliser le module Â«â€¯Google Cloud Storageâ€¯Â» pour arriver Ã  un rÃ©sultat identique.</p>
<p>Configuration Graphite
Il paraÃ®t Ã©vident quâ€™une chaÃ®ne de CI/CD sans monitoring nâ€™en est pas vraiment uneâ€¦ Mais Ã§a va toujours mieux en le reprÃ©cisant ðŸ™‚ Dans ce scope, Graphite reste bien sÃ»r un standard et nous allons donc utiliser le module correspondant pour pouvoir rÃ©cupÃ©rer lâ€™ensemble des mÃ©triques rÃ©coltÃ©es par sitepseedio au cours dâ€™un test. Grafana permettra la visualisation des mÃ©triques rÃ©coltÃ©es. Voici la configuration du module Graphite:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">graphite</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> { <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">host</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">192.168.1.79</span> <span style="color:#960050;background-color:#1e0010">Â»,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">port</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">9109,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">includeQueryParams</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">false,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">arrayTags</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">false,</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">namespace</span> <span style="color:#960050;background-color:#1e0010">Â»:</span> <span style="color:#960050;background-color:#1e0010">Â«</span> <span style="color:#960050;background-color:#1e0010">speedio</span> <span style="color:#960050;background-color:#1e0010">Â»</span> }<span style="color:#960050;background-color:#1e0010">,</span>
</code></pre></div><p>Câ€™est une configuration minimale pour envoyer les mÃ©triques vers un serveur compatible Graphite mais vous pouvez aller beaucoup plus loin avec des tags, des annotations Ã  disposition. Pour ma part, jâ€™utilise plutÃ´t Prometheus que Graphite et jâ€™ai donc utilisÃ© Graphite Exporter et ces possibilitÃ©s de Â«â€¯mappingâ€¯Â» pour arriver au mÃªme rÃ©sultat quâ€™avec un serveur Graphite. Vous pouvez aussi utiliser InfluxDB en lieu et place de Graphite si tel est votre bon plaisir.</p>
<p>Autres options de configuration intÃ©ressantes
Je nâ€™ai pas encore mis en oeuvre les options de configuration suivantes mais il est possible, Ã  lâ€™instar du module Graphite vu plus haut, dâ€™envoyer des annotations vers Grafana. Il est Ã©galement possible de paramÃ©trer un Â«â€¯budget performance Â» pour votre application. Et enfin, la toute nouvelle version 12 de sitespeed.io permet dÃ©sormais de calculer lâ€™impact Ã©cologique de votre application web.</p>
<p>INTÃ‰GRATION CI/CD
Une fois sitespeed.io configurÃ©, il ne reste plus quâ€™Ã  orchestrer le tout avec lâ€™outil de votre choix; Ansible dans mon cas. Voici donc un playbook Â«â€¯quick and dirtyâ€¯Â» permettant de charger la liste des sites Ã  tester depuis un fichier web.txt et de crÃ©er le conteneur Docker pour chacun. Notez lâ€™appel au fichier de configuration avec &ndash;config config.json. Un script bash aurait certainement pu faire lâ€™affaire mais utiliser Ansible ou un Ã©quivalent permet de pouvoir paramÃ©trer le tout finement et dâ€™aller plus loin avec par exemple un fichier de configuration diffÃ©rent par applicationâ€¦</p>
<p>â€” â€“ name: sitespeed.io docker run hosts: localhost connection: local gather_facts: no become: no vars: iso8601_date: Â« {{ lookup(â€˜pipeâ€™, â€˜date -u +%Y-%m-%dT%H:%M:%S+00:00â€™) }}Â«  root_dir: Â« {{ lookup(â€˜envâ€™, â€˜PWDâ€™) }}Â«  tasks: â€“ name: docker_container | check url from file â€˜web.txtâ€™ with sitespeed.io docker_container: name: Â« speedio_{{ site_idx }}Â«  image: sitespeedio/sitespeed.io:12.1.0 auto_remove: yes network_mode: bridge recreate: yes command: Â« {{ item }} â€“config config.json Â» env: https_proxy: Â«  Â» http_proxy: Â«  Â» volumes: â€“ Â« {{ root_dir }}:/sitespeed.io Â» loop: Â« {{ lookup(â€˜fileâ€™, â€˜./web.txtâ€™).splitlines() }}Â«  loop_control: index_var: site_idx
Ceci nâ€™est bien sÃ»r quâ€™une base Ansible Ã  adapter Ã  votre environnement, votre contexte. Il reste Ã  intÃ©grer ce playbook dans un pipeline CI/CD, que ce soit Jenkins, Gitlab, Github ou Drone. Il est Ã©galement possible dâ€™exÃ©cuter ce playbook Ã  intervalles rÃ©guliers depuis Jenkins, Rundeck, AWX ou depuis votre logiciel de supervision.</p>
<p>En fonction de lâ€™intÃ©gration choisie, il peut y avoir pas mal de travail annexe Ã  faire comme la construction de tableaux de bord pour Grafana, un fichier de mapping pour Graphite Exporterâ€¦ En guise de conclusion, les combinaisons envisageables sont trÃ¨s Ã©tendues.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/introduction_au_serverless/">
                  <span class="button__text">Introduction au serverless</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Klanik tech blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >Â© 2020 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
